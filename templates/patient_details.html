{% extends "base.html" %}

{% block title %}{{ patient['name'] }} - ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ù…Ø±ÙŠØ¶{% endblock %}

{% block content %}
<div class="page-header">
    <h2>ğŸ‘¤ {{ patient['name'] }}</h2>
    <div class="action-buttons">
        <a href="{{ url_for('new_visit', patient_id=patient['id']) }}" class="btn btn-primary">
            â• Ø²ÙŠØ§Ø±Ø© Ø¬Ø¯ÙŠØ¯Ø©
        </a>
        <a href="{{ url_for('new_appointment', patient_id=patient['id']) }}" class="btn btn-success">
            ğŸ“… Ù…ÙˆØ¹Ø¯ Ø¬Ø¯ÙŠØ¯
        </a>
        <a href="{{ url_for('export_patient', patient_id=patient['id']) }}" class="btn btn-secondary" target="_blank">
            ğŸ“„ ØªØµØ¯ÙŠØ± Ø§Ù„Ù…Ù„Ù
        </a>
        <button onclick="deletePatient({{ patient['id'] }}, '{{ patient['name'] }}')" class="btn btn-danger">
            ğŸ—‘ï¸ Ø­Ø°Ù Ø§Ù„Ù…Ø±ÙŠØ¶
        </button>
    </div>
</div>

<div class="patient-info-card">
    <h3>Ø§Ù„Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ø´Ø®ØµÙŠØ©</h3>
    <div class="info-grid">
        <div class="info-item">
            <strong>Ø§Ù„Ø¹Ù…Ø±:</strong> {{ patient['age'] or 'Ù„Ø§ ÙŠÙˆØ¬Ø¯' }}
        </div>
        <div class="info-item">
            <strong>Ø§Ù„Ø¬Ù†Ø³:</strong> {{ patient['gender'] or 'Ù„Ø§ ÙŠÙˆØ¬Ø¯' }}
        </div>
        <div class="info-item">
            <strong>Ø§Ù„Ù‡Ø§ØªÙ:</strong> {{ patient['phone'] or 'Ù„Ø§ ÙŠÙˆØ¬Ø¯' }}
        </div>
        <div class="info-item">
            <strong>Ø§Ù„Ø¨Ø±ÙŠØ¯:</strong> {{ patient['email'] or 'Ù„Ø§ ÙŠÙˆØ¬Ø¯' }}
        </div>
        <div class="info-item">
            <strong>Ø±Ù‚Ù… Ø§Ù„Ù‡ÙˆÙŠØ©:</strong> {{ patient['national_id'] or 'Ù„Ø§ ÙŠÙˆØ¬Ø¯' }}
        </div>
        <div class="info-item">
            <strong>Ø§Ù„Ø¹Ù†ÙˆØ§Ù†:</strong> {{ patient['address'] or 'Ù„Ø§ ÙŠÙˆØ¬Ø¯' }}
        </div>
    </div>
</div>

<div class="patient-info-card medical-info">
    <h3>ğŸ©º Ø§Ù„Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ø·Ø¨ÙŠØ©</h3>
    <div class="info-grid">
        <div class="info-item">
            <strong>ÙØµÙŠÙ„Ø© Ø§Ù„Ø¯Ù…:</strong> 
            <span class="blood-type">{{ patient['blood_type'] or 'Ù„Ø§ ÙŠÙˆØ¬Ø¯' }}</span>
        </div>
        <div class="info-item">
            <strong>Ø§Ù„Ø­Ø³Ø§Ø³ÙŠØ©:</strong> {{ patient['allergies'] or 'Ù„Ø§ ÙŠÙˆØ¬Ø¯' }}
        </div>
        <div class="info-item full-width">
            <strong>Ø§Ù„Ø£Ù…Ø±Ø§Ø¶ Ø§Ù„Ù…Ø²Ù…Ù†Ø©:</strong> {{ patient['chronic_diseases'] or 'Ù„Ø§ ÙŠÙˆØ¬Ø¯' }}
        </div>
        <div class="info-item full-width">
            <strong>Ø§Ù„Ø£Ø¯ÙˆÙŠØ© Ø§Ù„Ø­Ø§Ù„ÙŠØ©:</strong> {{ patient['current_medications'] or 'Ù„Ø§ ÙŠÙˆØ¬Ø¯' }}
        </div>
    </div>
</div>

<div class="patient-info-card">
    <h3>ğŸš¨ Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ø·ÙˆØ§Ø±Ø¦</h3>
    <div class="info-grid">
        <div class="info-item">
            <strong>Ø¬Ù‡Ø© Ø§Ù„Ø§ØªØµØ§Ù„:</strong> {{ patient['emergency_contact'] or 'Ù„Ø§ ÙŠÙˆØ¬Ø¯' }}
        </div>
        <div class="info-item">
            <strong>Ø±Ù‚Ù… Ø§Ù„Ø·ÙˆØ§Ø±Ø¦:</strong> {{ patient['emergency_phone'] or 'Ù„Ø§ ÙŠÙˆØ¬Ø¯' }}
        </div>
    </div>
</div>

<div class="patient-info-card">
    <h3>ğŸ’³ Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„ØªØ£Ù…ÙŠÙ†</h3>
    <div class="info-grid">
        <div class="info-item">
            <strong>Ø´Ø±ÙƒØ© Ø§Ù„ØªØ£Ù…ÙŠÙ†:</strong> {{ patient['insurance_company'] or 'Ù„Ø§ ÙŠÙˆØ¬Ø¯' }}
        </div>
        <div class="info-item">
            <strong>Ø±Ù‚Ù… Ø§Ù„Ø¨ÙˆÙ„ÙŠØµØ©:</strong> {{ patient['insurance_number'] or 'Ù„Ø§ ÙŠÙˆØ¬Ø¯' }}
        </div>
    </div>
</div>

{% if patient['notes'] %}
<div class="patient-info-card">
    <h3>ğŸ“ Ù…Ù„Ø§Ø­Ø¸Ø§Øª</h3>
    <p>{{ patient['notes'] }}</p>
</div>
{% endif %}

<div class="financial-summary">
    <h3>Ø§Ù„Ù…Ù„Ø®Øµ Ø§Ù„Ù…Ø§Ù„ÙŠ</h3>
    <div class="summary-cards">
        <div class="summary-card">
            <div class="summary-label">Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø±Ø³ÙˆÙ…</div>
            <div class="summary-value">{{ "%.2f"|format(summary['total_charges']) }}</div>
        </div>
        <div class="summary-card success">
            <div class="summary-label">Ø§Ù„Ù…Ø¯ÙÙˆØ¹</div>
            <div class="summary-value">{{ "%.2f"|format(summary['total_paid']) }}</div>
        </div>
        <div class="summary-card {% if summary['total_debt'] > 0 %}danger{% endif %}">
            <div class="summary-label">Ø§Ù„Ø¯ÙŠÙ† Ø§Ù„Ù…ØªØ¨Ù‚ÙŠ</div>
            <div class="summary-value">{{ "%.2f"|format(summary['total_debt']) }}</div>
        </div>
    </div>
</div>

<div class="visits-section">
    <h3>ğŸ¥ Ø³Ø¬Ù„ Ø§Ù„Ø²ÙŠØ§Ø±Ø§Øª Ø§Ù„Ø·Ø¨ÙŠØ©</h3>
    {% if visits %}
    <div class="visits-list">
        {% for visit in visits %}
        <div class="visit-card">
            <div class="visit-header">
                <span class="visit-date">ğŸ“… {{ visit['visit_date'][:16] }}</span>
                {% if visit['remaining_debt'] > 0 %}
                <span class="badge badge-danger">Ø¯ÙŠÙ†: {{ "%.2f"|format(visit['remaining_debt']) }}</span>
                {% else %}
                <span class="badge badge-success">Ù…Ø³Ø¯Ø¯</span>
                {% endif %}
            </div>
            
            <div class="visit-body">
                {% if visit['symptoms'] %}
                <div class="visit-info">
                    <strong>ğŸ¤’ Ø§Ù„Ø£Ø¹Ø±Ø§Ø¶:</strong>
                    <p>{{ visit['symptoms'] }}</p>
                </div>
                {% endif %}
                
                {% if visit['vital_signs'] %}
                <div class="visit-info">
                    <strong>ğŸ“Š Ø§Ù„Ø¹Ù„Ø§Ù…Ø§Øª Ø§Ù„Ø­ÙŠÙˆÙŠØ©:</strong>
                    <p>{{ visit['vital_signs'] }}</p>
                </div>
                {% endif %}
                
                <div class="visit-info">
                    <strong>ğŸ” Ø§Ù„ØªØ´Ø®ÙŠØµ:</strong>
                    <p>{{ visit['diagnosis'] or 'Ù„Ø§ ÙŠÙˆØ¬Ø¯' }}</p>
                </div>
                
                <div class="visit-info">
                    <strong>ğŸ’Š Ø§Ù„Ø¹Ù„Ø§Ø¬:</strong>
                    <p>{{ visit['treatment'] or 'Ù„Ø§ ÙŠÙˆØ¬Ø¯' }}</p>
                </div>
                
                {% if visit['prescriptions'] %}
                <div class="visit-info prescription-box">
                    <strong>ğŸ“‹ Ø§Ù„ÙˆØµÙØ© Ø§Ù„Ø·Ø¨ÙŠØ©:</strong>
                    <pre>{{ visit['prescriptions'] }}</pre>
                </div>
                {% endif %}
                
                {% if visit['lab_tests'] %}
                <div class="visit-info">
                    <strong>ğŸ§ª Ø§Ù„ÙØ­ÙˆØµØ§Øª Ø§Ù„Ù…Ø·Ù„ÙˆØ¨Ø©:</strong>
                    <p>{{ visit['lab_tests'] }}</p>
                </div>
                {% endif %}
                
                {% if visit['next_visit_date'] %}
                <div class="visit-info">
                    <strong>ğŸ“… Ù…ÙˆØ¹Ø¯ Ø§Ù„Ù…Ø±Ø§Ø¬Ø¹Ø© Ø§Ù„Ù‚Ø§Ø¯Ù…:</strong>
                    <p>{{ visit['next_visit_date'] }}</p>
                </div>
                {% endif %}
                
                {% if visit['notes'] %}
                <div class="visit-info">
                    <strong>ğŸ“ Ù…Ù„Ø§Ø­Ø¸Ø§Øª:</strong>
                    <p>{{ visit['notes'] }}</p>
                </div>
                {% endif %}
                
                <div class="visit-financial">
                    <div class="financial-item">
                        <span>Ø§Ù„ØªÙƒÙ„ÙØ©:</span>
                        <strong>{{ "%.2f"|format(visit['total_cost']) }}</strong>
                    </div>
                    <div class="financial-item">
                        <span>Ø§Ù„Ù…Ø¯ÙÙˆØ¹:</span>
                        <strong>{{ "%.2f"|format(visit['paid_amount']) }}</strong>
                    </div>
                    <div class="financial-item {% if visit['remaining_debt'] > 0 %}debt-text{% endif %}">
                        <span>Ø§Ù„Ù…ØªØ¨Ù‚ÙŠ:</span>
                        <strong>{{ "%.2f"|format(visit['remaining_debt']) }}</strong>
                    </div>
                </div>
                
                {% if visit['remaining_debt'] > 0 %}
                <button class="btn btn-small btn-success" 
                        onclick="showPaymentModal({{ visit['id'] }}, {{ visit['remaining_debt'] }})">
                    ğŸ’° Ø¥Ø¶Ø§ÙØ© Ø¯ÙØ¹Ø©
                </button>
                {% endif %}
                <a href="{{ url_for('export_visit', visit_id=visit['id']) }}" 
                   class="btn btn-small" target="_blank">
                    ğŸ“„ ØªØµØ¯ÙŠØ±
                </a>
            </div>
        </div>
        {% endfor %}
    </div>
    {% else %}
    <p class="no-data">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø²ÙŠØ§Ø±Ø§Øª Ù…Ø³Ø¬Ù„Ø© Ù„Ù‡Ø°Ø§ Ø§Ù„Ù…Ø±ÙŠØ¶</p>
    {% endif %}
</div>

<!-- Payment Modal -->
<div id="paymentModal" class="modal">
    <div class="modal-content">
        <span class="close" onclick="closePaymentModal()">&times;</span>
        <h3>Ø¥Ø¶Ø§ÙØ© Ø¯ÙØ¹Ø©</h3>
        <form id="paymentForm">
            <input type="hidden" id="visitId">
            
            <div class="form-group">
                <label>Ø§Ù„Ù…Ø¨Ù„Øº Ø§Ù„Ù…ØªØ¨Ù‚ÙŠ:</label>
                <div id="remainingAmount" class="debt-amount"></div>
            </div>
            
            <div class="form-group">
                <label for="paymentAmount">Ø§Ù„Ù…Ø¨Ù„Øº Ø§Ù„Ù…Ø¯ÙÙˆØ¹ *</label>
                <div class="input-with-voice">
                    <input type="number" id="paymentAmount" step="0.01" required>
                    <button type="button" class="voice-btn" data-target="paymentAmount">ğŸ¤</button>
                </div>
            </div>
            
            <div class="form-group">
                <label for="paymentMethod">Ø·Ø±ÙŠÙ‚Ø© Ø§Ù„Ø¯ÙØ¹</label>
                <select id="paymentMethod">
                    <option value="Ù†Ù‚Ø¯ÙŠ">Ù†Ù‚Ø¯ÙŠ</option>
                    <option value="Ø¨Ø·Ø§Ù‚Ø©">Ø¨Ø·Ø§Ù‚Ø©</option>
                    <option value="ØªØ­ÙˆÙŠÙ„">ØªØ­ÙˆÙŠÙ„ Ø¨Ù†ÙƒÙŠ</option>
                </select>
            </div>
            
            <div class="form-group">
                <label for="paymentNotes">Ù…Ù„Ø§Ø­Ø¸Ø§Øª</label>
                <div class="input-with-voice">
                    <textarea id="paymentNotes" rows="2"></textarea>
                    <button type="button" class="voice-btn" data-target="paymentNotes">ğŸ¤</button>
                </div>
            </div>
            
            <div class="form-actions">
                <button type="submit" class="btn btn-primary">Ø­ÙØ¸ Ø§Ù„Ø¯ÙØ¹Ø©</button>
                <button type="button" class="btn btn-secondary" onclick="closePaymentModal()">
                    Ø¥Ù„ØºØ§Ø¡
                </button>
            </div>
        </form>
    </div>
</div>
{% endblock %}

{% block extra_scripts %}
<script src="{{ url_for('static', filename='js/voice.js') }}"></script>
<script>
function showPaymentModal(visitId, remainingAmount) {
    document.getElementById('visitId').value = visitId;
    document.getElementById('remainingAmount').textContent = remainingAmount.toFixed(2);
    document.getElementById('paymentModal').style.display = 'block';
}

function closePaymentModal() {
    document.getElementById('paymentModal').style.display = 'none';
    document.getElementById('paymentForm').reset();
}

document.getElementById('paymentForm').addEventListener('submit', async function(e) {
    e.preventDefault();
    
    const visitId = document.getElementById('visitId').value;
    const formData = {
        amount: document.getElementById('paymentAmount').value,
        payment_method: document.getElementById('paymentMethod').value,
        notes: document.getElementById('paymentNotes').value
    };
    
    try {
        const response = await fetch('/payment/add/' + visitId, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify(formData)
        });
        
        const result = await response.json();
        
        if (result.success) {
            alert('ØªÙ… Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ø¯ÙØ¹Ø© Ø¨Ù†Ø¬Ø§Ø­!');
            location.reload();
        }
    } catch (error) {
        alert('Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ø¯ÙØ¹Ø©');
        console.error(error);
    }
});

// Close modal when clicking outside
window.onclick = function(event) {
    const modal = document.getElementById('paymentModal');
    if (event.target == modal) {
        closePaymentModal();
    }
}

// Delete patient function
async function deletePatient(patientId, patientName) {
    const confirmMessage = `âš ï¸ ØªØ­Ø°ÙŠØ± Ø®Ø·ÙŠØ±!\n\nÙ‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø­Ø°Ù Ø§Ù„Ù…Ø±ÙŠØ¶ "${patientName}"ØŸ\n\nØ³ÙŠØªÙ… Ø­Ø°Ù:\nâ€¢ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø²ÙŠØ§Ø±Ø§Øª Ø§Ù„Ø·Ø¨ÙŠØ©\nâ€¢ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ù…ÙˆØ§Ø¹ÙŠØ¯\nâ€¢ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ù…Ø¯ÙÙˆØ¹Ø§Øª\nâ€¢ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø±ØªØ¨Ø·Ø©\n\nÙ‡Ø°Ø§ Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡ Ù„Ø§ ÙŠÙ…ÙƒÙ† Ø§Ù„ØªØ±Ø§Ø¬Ø¹ Ø¹Ù†Ù‡!`;
    
    if (!confirm(confirmMessage)) {
        return;
    }
    
    // ØªØ£ÙƒÙŠØ¯ Ù…Ø±Ø© Ø«Ø§Ù†ÙŠØ©
    if (!confirm(`Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ 100%ØŸ Ø³ÙŠØªÙ… Ø­Ø°Ù "${patientName}" Ù†Ù‡Ø§Ø¦ÙŠØ§Ù‹!`)) {
        return;
    }
    
    try {
        const response = await fetch(`/patient/${patientId}/delete`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            }
        });
        
        const result = await response.json();
        
        if (result.success) {
            alert('âœ… ØªÙ… Ø­Ø°Ù Ø§Ù„Ù…Ø±ÙŠØ¶ Ø¨Ù†Ø¬Ø§Ø­');
            window.location.href = '/patients';
        } else {
            alert('âŒ Ø­Ø¯Ø« Ø®Ø·Ø£: ' + (result.error || 'Ø®Ø·Ø£ ØºÙŠØ± Ù…Ø¹Ø±ÙˆÙ'));
        }
    } catch (error) {
        alert('âŒ Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø­Ø°Ù Ø§Ù„Ù…Ø±ÙŠØ¶');
        console.error(error);
    }
}
</script>
{% endblock %}
