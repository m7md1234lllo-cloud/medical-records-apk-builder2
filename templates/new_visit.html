{% extends "base.html" %}

{% block title %}Ø²ÙŠØ§Ø±Ø© Ø¬Ø¯ÙŠØ¯Ø© - {{ patient['name'] }}{% endblock %}

{% block content %}
<div class="form-container">
    <h2>â• Ø²ÙŠØ§Ø±Ø© Ø¬Ø¯ÙŠØ¯Ø© - {{ patient['name'] }}</h2>
    
    <form id="newVisitForm">
        <!-- Ø§Ù„Ø£Ø·Ø¨Ø§Ø¡ -->
        <div class="form-section" style="background: linear-gradient(135deg, #e3f2fd 0%, #bbdefb 100%); border-right-color: #2196f3;">
            <h3>ğŸ‘¨â€âš•ï¸ Ø§Ù„ÙØ±ÙŠÙ‚ Ø§Ù„Ø·Ø¨ÙŠ</h3>
            
            <div class="form-group">
                <label for="doctor_id">Ø§Ù„Ø·Ø¨ÙŠØ¨ Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠ *</label>
                <select id="doctor_id" name="doctor_id" required>
                    <option value="">-- Ø§Ø®ØªØ± Ø§Ù„Ø·Ø¨ÙŠØ¨ Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠ --</option>
                    {% for doctor in doctors %}
                    <option value="{{ doctor['id'] }}">
                        Ø¯. {{ doctor['name'] }}{% if doctor['specialization'] %} - {{ doctor['specialization'] }}{% endif %}
                    </option>
                    {% endfor %}
                </select>
            </div>
            
            <div class="participating-doctors-section">
                <div class="section-header" style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
                    <label style="margin: 0; font-size: 1.15rem; color: #1a1a2e;">Ø§Ù„Ø£Ø·Ø¨Ø§Ø¡ Ø§Ù„Ù…Ø´Ø§Ø±ÙƒÙŠÙ† (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)</label>
                    <button type="button" class="btn btn-small" onclick="addParticipatingDoctor()" style="background: linear-gradient(135deg, #2196f3 0%, #1976d2 100%);">
                        â• Ø¥Ø¶Ø§ÙØ© Ø·Ø¨ÙŠØ¨ Ù…Ø´Ø§Ø±Ùƒ
                    </button>
                </div>
                
                <div id="participatingDoctorsList" style="display: grid; gap: 1rem;">
                    <!-- Ø³ÙŠØªÙ… Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ø£Ø·Ø¨Ø§Ø¡ Ø§Ù„Ù…Ø´Ø§Ø±ÙƒÙŠÙ† Ù‡Ù†Ø§ Ø¯ÙŠÙ†Ø§Ù…ÙŠÙƒÙŠØ§Ù‹ -->
                </div>
            </div>
            
            <div class="info-box" style="background: linear-gradient(135deg, #fff3cd 0%, #ffe69c 100%); padding: 1rem; border-radius: 8px; margin-top: 1rem; border-right: 4px solid #ffc107;">
                <strong style="color: #856404; display: block; margin-bottom: 0.5rem;">ğŸ’¡ Ø§Ù„Ø¹Ù…Ù„ÙŠØ§Øª Ø§Ù„Ù…Ø´ØªØ±ÙƒØ©:</strong>
                <p style="color: #856404; margin: 0; font-size: 0.95rem;">
                    ÙÙŠ Ø­Ø§Ù„Ø© Ø§Ù„Ø¹Ù…Ù„ÙŠØ§Øª Ø§Ù„Ø¬Ø±Ø§Ø­ÙŠØ© Ø£Ùˆ Ø§Ù„Ø­Ø§Ù„Ø§Øª Ø§Ù„Ù…Ø¹Ù‚Ø¯Ø©ØŒ ÙŠÙ…ÙƒÙ†Ùƒ Ø¥Ø¶Ø§ÙØ© Ø¹Ø¯Ø© Ø£Ø·Ø¨Ø§Ø¡ Ù…Ø´Ø§Ø±ÙƒÙŠÙ† Ù…Ø¹ ØªØ­Ø¯ÙŠØ¯ Ø¯ÙˆØ± ÙƒÙ„ Ø·Ø¨ÙŠØ¨.
                </p>
            </div>
        </div>
        
        <!-- Ø§Ù„Ø£Ø¹Ø±Ø§Ø¶ -->
        <div class="form-section">
            <h3>ğŸ¤’ Ø§Ù„Ø£Ø¹Ø±Ø§Ø¶</h3>
            
            <div class="form-group">
                <label for="symptoms">Ø§Ù„Ø£Ø¹Ø±Ø§Ø¶ Ø§Ù„ØªÙŠ ÙŠØ´ÙƒÙˆ Ù…Ù†Ù‡Ø§ Ø§Ù„Ù…Ø±ÙŠØ¶ *</label>
                <div class="input-with-voice">
                    <textarea id="symptoms" name="symptoms" rows="3" required
                              placeholder="Ù…Ø«Ø§Ù„: ØµØ¯Ø§Ø¹ Ø´Ø¯ÙŠØ¯ØŒ Ø­Ù…Ù‰ØŒ Ø£Ù„Ù… ÙÙŠ Ø§Ù„Ø¨Ø·Ù†"></textarea>
                    <button type="button" class="voice-btn" data-target="symptoms">ğŸ¤</button>
                </div>
            </div>
        </div>

        <!-- Ø§Ù„Ø¹Ù„Ø§Ù…Ø§Øª Ø§Ù„Ø­ÙŠÙˆÙŠØ© -->
        <div class="form-section">
            <h3>ğŸ“Š Ø§Ù„Ø¹Ù„Ø§Ù…Ø§Øª Ø§Ù„Ø­ÙŠÙˆÙŠØ©</h3>
            
            <div class="form-group">
                <label for="vital_signs">Ø§Ù„Ø¹Ù„Ø§Ù…Ø§Øª Ø§Ù„Ø­ÙŠÙˆÙŠØ©</label>
                <div class="input-with-voice">
                    <textarea id="vital_signs" name="vital_signs" rows="2"
                              placeholder="Ø¶ØºØ· Ø§Ù„Ø¯Ù…: 120/80ØŒ Ø§Ù„Ù†Ø¨Ø¶: 75ØŒ Ø§Ù„Ø­Ø±Ø§Ø±Ø©: 37Â°Ù…ØŒ Ø§Ù„ØªÙ†ÙØ³: 18ØŒ Ø§Ù„Ø£ÙƒØ³Ø¬ÙŠÙ†: 98%"></textarea>
                    <button type="button" class="voice-btn" data-target="vital_signs">ğŸ¤</button>
                </div>
            </div>
        </div>

        <!-- Ø§Ù„ØªØ´Ø®ÙŠØµ -->
        <div class="form-section">
            <h3>ğŸ” Ø§Ù„ØªØ´Ø®ÙŠØµ</h3>
            
            <div class="form-group">
                <label for="diagnosis">Ø§Ù„ØªØ´Ø®ÙŠØµ *</label>
                <div class="input-with-voice">
                    <textarea id="diagnosis" name="diagnosis" rows="3" required
                              placeholder="Ø§Ù„ØªØ´Ø®ÙŠØµ Ø§Ù„Ø·Ø¨ÙŠ Ù„Ù„Ø­Ø§Ù„Ø©"></textarea>
                    <button type="button" class="voice-btn" data-target="diagnosis">ğŸ¤</button>
                </div>
            </div>
        </div>

        <!-- Ø§Ù„Ø¹Ù„Ø§Ø¬ -->
        <div class="form-section">
            <h3>ğŸ’Š Ø§Ù„Ø¹Ù„Ø§Ø¬</h3>
            
            <div class="form-group">
                <label for="treatment">Ø®Ø·Ø© Ø§Ù„Ø¹Ù„Ø§Ø¬ *</label>
                <div class="input-with-voice">
                    <textarea id="treatment" name="treatment" rows="3" required
                              placeholder="ÙˆØµÙ Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª Ø§Ù„Ø¹Ù„Ø§Ø¬ÙŠØ©"></textarea>
                    <button type="button" class="voice-btn" data-target="treatment">ğŸ¤</button>
                </div>
            </div>

            <div class="form-group">
                <label for="prescriptions">Ø§Ù„ÙˆØµÙØ© Ø§Ù„Ø·Ø¨ÙŠØ© (Ø§Ù„Ø£Ø¯ÙˆÙŠØ©)</label>
                <div class="input-with-voice">
                    <textarea id="prescriptions" name="prescriptions" rows="4"
                              placeholder="Ù…Ø«Ø§Ù„:
1. Paracetamol 500mg - 3 Ù…Ø±Ø§Øª ÙŠÙˆÙ…ÙŠØ§Ù‹ Ø¨Ø¹Ø¯ Ø§Ù„Ø£ÙƒÙ„
2. Amoxicillin 500mg - Ù…Ø±ØªÙŠÙ† ÙŠÙˆÙ…ÙŠØ§Ù‹ Ù„Ù…Ø¯Ø© 7 Ø£ÙŠØ§Ù…"></textarea>
                    <button type="button" class="voice-btn" data-target="prescriptions">ğŸ¤</button>
                </div>
            </div>
        </div>

        <!-- Ø§Ù„ÙØ­ÙˆØµØ§Øª -->
        <div class="form-section">
            <h3>ğŸ§ª Ø§Ù„ÙØ­ÙˆØµØ§Øª Ø§Ù„Ù…Ø®Ø¨Ø±ÙŠØ©</h3>
            
            <div class="form-group">
                <label for="lab_tests">Ø§Ù„ÙØ­ÙˆØµØ§Øª Ø§Ù„Ù…Ø·Ù„ÙˆØ¨Ø©</label>
                <div class="input-with-voice">
                    <textarea id="lab_tests" name="lab_tests" rows="3"
                              placeholder="Ù…Ø«Ø§Ù„: ØªØ­Ù„ÙŠÙ„ ØµÙˆØ±Ø© Ø¯Ù… ÙƒØ§Ù…Ù„Ø©ØŒ ØªØ­Ù„ÙŠÙ„ Ø³ÙƒØ±ØŒ Ø£Ø´Ø¹Ø©"></textarea>
                    <button type="button" class="voice-btn" data-target="lab_tests">ğŸ¤</button>
                </div>
            </div>
        </div>

        <!-- Ø§Ù„Ù…ÙˆØ¹Ø¯ Ø§Ù„Ù‚Ø§Ø¯Ù… -->
        <div class="form-section">
            <h3>ğŸ“… Ø§Ù„Ù…ØªØ§Ø¨Ø¹Ø©</h3>
            
            <div class="form-group">
                <label for="next_visit_date">Ù…ÙˆØ¹Ø¯ Ø§Ù„Ù…Ø±Ø§Ø¬Ø¹Ø© Ø§Ù„Ù‚Ø§Ø¯Ù…</label>
                <input type="date" id="next_visit_date" name="next_visit_date">
            </div>
        </div>

        <!-- Ù…Ù„Ø§Ø­Ø¸Ø§Øª Ø¥Ø¶Ø§ÙÙŠØ© -->
        <div class="form-section">
            <h3>ğŸ“ Ù…Ù„Ø§Ø­Ø¸Ø§Øª</h3>
            
            <div class="form-group">
                <label for="notes">Ù…Ù„Ø§Ø­Ø¸Ø§Øª Ø¥Ø¶Ø§ÙÙŠØ©</label>
                <div class="input-with-voice">
                    <textarea id="notes" name="notes" rows="2"></textarea>
                    <button type="button" class="voice-btn" data-target="notes">ğŸ¤</button>
                </div>
            </div>
        </div>

        <!-- Ø§Ù„Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ù…Ø§Ù„ÙŠØ© -->
        <div class="form-section">
            <h3>ğŸ’° Ø§Ù„Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ù…Ø§Ù„ÙŠØ©</h3>
            
            <div class="form-row">
                <div class="form-group">
                    <label for="total_cost">Ø§Ù„ØªÙƒÙ„ÙØ© Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠØ© *</label>
                    <div class="input-with-voice">
                        <input type="number" id="total_cost" name="total_cost" 
                               step="0.01" required value="0">
                        <button type="button" class="voice-btn" data-target="total_cost">ğŸ¤</button>
                    </div>
                </div>

                <div class="form-group">
                    <label for="paid_amount">Ø§Ù„Ù…Ø¨Ù„Øº Ø§Ù„Ù…Ø¯ÙÙˆØ¹</label>
                    <div class="input-with-voice">
                        <input type="number" id="paid_amount" name="paid_amount" 
                               step="0.01" value="0">
                        <button type="button" class="voice-btn" data-target="paid_amount">ğŸ¤</button>
                    </div>
                </div>
            </div>

            <div class="form-group">
                <label for="payment_method">Ø·Ø±ÙŠÙ‚Ø© Ø§Ù„Ø¯ÙØ¹</label>
                <select id="payment_method" name="payment_method">
                    <option value="Ù†Ù‚Ø¯ÙŠ">Ù†Ù‚Ø¯ÙŠ</option>
                    <option value="Ø¨Ø·Ø§Ù‚Ø©">Ø¨Ø·Ø§Ù‚Ø©</option>
                    <option value="ØªØ­ÙˆÙŠÙ„">ØªØ­ÙˆÙŠÙ„ Ø¨Ù†ÙƒÙŠ</option>
                    <option value="ØªØ£Ù…ÙŠÙ†">ØªØ£Ù…ÙŠÙ† ØµØ­ÙŠ</option>
                </select>
            </div>

            <div class="info-box">
                <strong>ğŸ’³ Ø§Ù„Ù…Ø¨Ù„Øº Ø§Ù„Ù…ØªØ¨Ù‚ÙŠ:</strong>
                <span id="remaining" class="debt-amount">0.00</span>
            </div>
        </div>

        <div class="form-actions">
            <button type="submit" class="btn btn-primary">ğŸ’¾ Ø­ÙØ¸ Ø§Ù„Ø²ÙŠØ§Ø±Ø©</button>
            <a href="{{ url_for('patient_details', patient_id=patient['id']) }}" 
               class="btn btn-secondary">Ø¥Ù„ØºØ§Ø¡</a>
        </div>
    </form>
</div>
{% endblock %}

{% block extra_scripts %}
<script src="{{ url_for('static', filename='js/voice.js') }}"></script>
<script>
// Calculate remaining amount
function updateRemaining() {
    const total = parseFloat(document.getElementById('total_cost').value) || 0;
    const paid = parseFloat(document.getElementById('paid_amount').value) || 0;
    const remaining = total - paid;
    document.getElementById('remaining').textContent = remaining.toFixed(2);
}

document.getElementById('total_cost').addEventListener('input', updateRemaining);
document.getElementById('paid_amount').addEventListener('input', updateRemaining);

document.getElementById('newVisitForm').addEventListener('submit', async function(e) {
    e.preventDefault();
    
    const formData = {
        doctor_id: document.getElementById('doctor_id').value || null,
        symptoms: document.getElementById('symptoms').value,
        vital_signs: document.getElementById('vital_signs').value,
        diagnosis: document.getElementById('diagnosis').value,
        treatment: document.getElementById('treatment').value,
        prescriptions: document.getElementById('prescriptions').value,
        lab_tests: document.getElementById('lab_tests').value,
        next_visit_date: document.getElementById('next_visit_date').value,
        notes: document.getElementById('notes').value,
        total_cost: document.getElementById('total_cost').value,
        paid_amount: document.getElementById('paid_amount').value,
        payment_method: document.getElementById('payment_method').value
    };
    
    try {
        const response = await fetch('/visit/new/{{ patient["id"] }}', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify(formData)
        });
        
        const result = await response.json();
        
        if (result.success) {
            alert('âœ… ØªÙ… Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ø²ÙŠØ§Ø±Ø© Ø¨Ù†Ø¬Ø§Ø­!');
            window.location.href = '/patient/{{ patient["id"] }}';
        }
    } catch (error) {
        alert('âŒ Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ø²ÙŠØ§Ø±Ø©');
        console.error(error);
    }
});
</script>
{% endblock %}
