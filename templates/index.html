{% extends "base.html" %}

{% block title %}Ø§Ù„ØµÙØ­Ø© Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ© - Ù†Ø¸Ø§Ù… Ø§Ù„Ù…Ù„ÙØ§Øª Ø§Ù„Ø·Ø¨ÙŠØ©{% endblock %}

{% block content %}
<div class="dashboard-hero">
    <h2>ğŸ¥ Ù†Ø¸Ø§Ù… Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…Ù„ÙØ§Øª Ø§Ù„Ø·Ø¨ÙŠØ©</h2>
    <p>Ø¥Ø¯Ø§Ø±Ø© Ø§Ø­ØªØ±Ø§ÙÙŠØ© Ù„Ø¹ÙŠØ§Ø¯ØªÙƒ Ø§Ù„Ø·Ø¨ÙŠØ©</p>
</div>

<div class="dashboard-widgets">
    <!-- Revenue Widget -->
    <div class="widget revenue-widget">
        <div class="widget-header">
            <h3>ğŸ’° Ø§Ù„Ø¥ÙŠØ±Ø§Ø¯Ø§Øª Ø§Ù„Ù…Ø§Ù„ÙŠØ©</h3>
            <a href="{{ url_for('reports') }}" class="widget-link">Ø§Ù„ØªÙØ§ØµÙŠÙ„ â†</a>
        </div>
        <div class="revenue-stats" id="revenueStats">
            <div class="loading">Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„...</div>
        </div>
    </div>
    
    <!-- Quick Stats -->
    <div class="widget stats-widget">
        <div class="widget-header">
            <h3>ğŸ“Š Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª Ø§Ù„Ø³Ø±ÙŠØ¹Ø©</h3>
        </div>
        <div class="quick-stats" id="quickStats">
            <div class="loading">Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„...</div>
        </div>
    </div>
</div>

<div class="search-section-enhanced">
    <h3>ğŸ” Ø§Ù„Ø¨Ø­Ø« Ø¹Ù† Ù…Ø±ÙŠØ¶</h3>
    <div class="search-box-enhanced">
        <input type="text" id="searchInput" placeholder="Ø§Ø¨Ø­Ø« Ø¨Ø§Ù„Ø§Ø³Ù… Ø£Ùˆ Ø±Ù‚Ù… Ø§Ù„Ù‡Ø§ØªÙ Ø£Ùˆ Ø±Ù‚Ù… Ø§Ù„Ù‡ÙˆÙŠØ©..." />
        <button id="voiceSearchBtn" class="voice-btn" title="Ø§Ù„Ø¨Ø­Ø« Ø§Ù„ØµÙˆØªÙŠ">ğŸ¤</button>
        <button class="search-clear" id="clearSearch" style="display:none;">âœ•</button>
    </div>
    
    <div class="search-filters" style="margin-top: 1rem; display: flex; gap: 1rem; flex-wrap: wrap;">
        <div class="filter-group">
            <label for="startDate" style="display: block; margin-bottom: 0.5rem; font-weight: 600;">Ù…Ù† ØªØ§Ø±ÙŠØ®:</label>
            <input type="date" id="startDate" class="filter-input" style="padding: 0.75rem; border: 2px solid #e0e0e0; border-radius: 10px; font-size: 1rem;">
        </div>
        <div class="filter-group">
            <label for="endDate" style="display: block; margin-bottom: 0.5rem; font-weight: 600;">Ø¥Ù„Ù‰ ØªØ§Ø±ÙŠØ®:</label>
            <input type="date" id="endDate" class="filter-input" style="padding: 0.75rem; border: 2px solid #e0e0e0; border-radius: 10px; font-size: 1rem;">
        </div>
        <div class="filter-group" style="display: flex; align-items: flex-end;">
            <button id="filterBtn" class="btn btn-primary" style="padding: 0.75rem 1.5rem;">ğŸ” Ø¨Ø­Ø« Ù…ØªÙ‚Ø¯Ù…</button>
        </div>
    </div>
    
    <div id="searchResults" class="search-results-enhanced"></div>
</div>

<div class="quick-actions-enhanced">
    <h3>âš¡ Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª Ø§Ù„Ø³Ø±ÙŠØ¹Ø©</h3>
    <div class="action-cards-grid">
        <a href="{{ url_for('new_patient') }}" class="action-card-enhanced">
            <div class="card-icon blue">ğŸ‘¤</div>
            <h4>Ù…Ø±ÙŠØ¶ Ø¬Ø¯ÙŠØ¯</h4>
            <p>ØªØ³Ø¬ÙŠÙ„ Ù…Ø±ÙŠØ¶ Ø¬Ø¯ÙŠØ¯ ÙÙŠ Ø§Ù„Ù†Ø¸Ø§Ù…</p>
        </a>
        
        <a href="{{ url_for('patients_list') }}" class="action-card-enhanced">
            <div class="card-icon green">ğŸ“‹</div>
            <h4>Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù…Ø±Ø¶Ù‰</h4>
            <p>Ø¹Ø±Ø¶ ÙˆØ¥Ø¯Ø§Ø±Ø© Ø¬Ù…ÙŠØ¹ Ø§Ù„Ù…Ø±Ø¶Ù‰</p>
        </a>
        
        <a href="{{ url_for('appointments_list') }}" class="action-card-enhanced">
            <div class="card-icon purple">ğŸ“…</div>
            <h4>Ø§Ù„Ù…ÙˆØ§Ø¹ÙŠØ¯</h4>
            <p>Ø¥Ø¯Ø§Ø±Ø© Ù…ÙˆØ§Ø¹ÙŠØ¯ Ø§Ù„Ù…Ø±Ø¶Ù‰</p>
        </a>
        
        <a href="{{ url_for('reports') }}" class="action-card-enhanced">
            <div class="card-icon orange">ğŸ“Š</div>
            <h4>Ø§Ù„ØªÙ‚Ø§Ø±ÙŠØ±</h4>
            <p>Ø§Ù„ØªÙ‚Ø§Ø±ÙŠØ± Ø§Ù„Ù…Ø§Ù„ÙŠØ© ÙˆØ§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª</p>
        </a>
    </div>
</div>
{% endblock %}

{% block extra_scripts %}
<script src="{{ url_for('static', filename='js/voice.js') }}"></script>
<script src="{{ url_for('static', filename='js/search.js') }}"></script>
<script>
// Load dashboard stats
async function loadDashboardStats() {
    try {
        const response = await fetch('/api/dashboard-stats');
        const stats = await response.json();
        
        const revenueStats = document.getElementById('revenueStats');
        const quickStats = document.getElementById('quickStats');
        
        revenueStats.innerHTML = `
            <div class="revenue-item">
                <div class="revenue-label">ğŸ’° Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø¥ÙŠØ±Ø§Ø¯Ø§Øª</div>
                <div class="revenue-value">${stats.total_revenue.toFixed(2)}</div>
            </div>
            <div class="revenue-item">
                <div class="revenue-label">âœ… Ø§Ù„Ù…Ø­ØµÙ„</div>
                <div class="revenue-value">${stats.total_collected.toFixed(2)}</div>
            </div>
            <div class="revenue-item" style="border-right-color: #dc3545;">
                <div class="revenue-label">â³ Ø§Ù„Ø¯ÙŠÙˆÙ†</div>
                <div class="revenue-value" style="color: #dc3545;">${stats.total_debt.toFixed(2)}</div>
            </div>
            <div class="revenue-item" style="border-right-color: #17a2b8;">
                <div class="revenue-label">ğŸ“… Ø§Ù„Ù…Ø­ØµÙ„ Ø§Ù„ÙŠÙˆÙ…</div>
                <div class="revenue-value" style="color: #17a2b8;">${stats.today_revenue.toFixed(2)}</div>
            </div>
        `;
        
        quickStats.innerHTML = `
            <div class="stat-item">
                <div class="stat-icon">ğŸ‘¥</div>
                <div class="stat-info">
                    <div class="stat-value">${stats.total_patients}</div>
                    <div class="stat-label">Ù…Ø±ÙŠØ¶</div>
                </div>
            </div>
            <div class="stat-item">
                <div class="stat-icon">ğŸ¥</div>
                <div class="stat-info">
                    <div class="stat-value">${stats.total_visits}</div>
                    <div class="stat-label">Ø²ÙŠØ§Ø±Ø©</div>
                </div>
            </div>
            <div class="stat-item">
                <div class="stat-icon">ğŸ“…</div>
                <div class="stat-info">
                    <div class="stat-value">${stats.today_appointments}</div>
                    <div class="stat-label">Ù…ÙˆØ¹Ø¯ Ø§Ù„ÙŠÙˆÙ…</div>
                </div>
            </div>
        `;
    } catch (error) {
        console.error('Error loading stats:', error);
        document.getElementById('revenueStats').innerHTML = '<div class="loading" style="color: #dc3545;">Ø­Ø¯Ø« Ø®Ø·Ø£ ÙÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª</div>';
        document.getElementById('quickStats').innerHTML = '<div class="loading" style="color: #dc3545;">Ø­Ø¯Ø« Ø®Ø·Ø£ ÙÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª</div>';
    }
}

// Clear search
document.getElementById('clearSearch').addEventListener('click', function() {
    document.getElementById('searchInput').value = '';
    document.getElementById('searchResults').innerHTML = '';
    document.getElementById('startDate').value = '';
    document.getElementById('endDate').value = '';
    this.style.display = 'none';
});

document.getElementById('searchInput').addEventListener('input', function() {
    const clearBtn = document.getElementById('clearSearch');
    clearBtn.style.display = this.value ? 'block' : 'none';
});

// Advanced search with date filters
document.getElementById('filterBtn').addEventListener('click', async function() {
    const query = document.getElementById('searchInput').value;
    const startDate = document.getElementById('startDate').value;
    const endDate = document.getElementById('endDate').value;
    
    if (!query && !startDate && !endDate) {
        alert('Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø¥Ø¯Ø®Ø§Ù„ ÙƒÙ„Ù…Ø© Ø¨Ø­Ø« Ø£Ùˆ ØªØ­Ø¯ÙŠØ¯ ØªØ§Ø±ÙŠØ®');
        return;
    }
    
    let url = '/search/advanced?';
    if (query) url += `q=${encodeURIComponent(query)}&`;
    if (startDate) url += `start_date=${startDate}&`;
    if (endDate) url += `end_date=${endDate}`;
    
    try {
        const response = await fetch(url);
        const results = await response.json();
        
        displaySearchResults(results);
    } catch (error) {
        console.error('Search error:', error);
        alert('Ø­Ø¯Ø« Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø¨Ø­Ø«');
    }
});

function displaySearchResults(results) {
    const resultsDiv = document.getElementById('searchResults');
    
    if (results.length === 0) {
        resultsDiv.innerHTML = '<p class="no-data">Ù„Ø§ ØªÙˆØ¬Ø¯ Ù†ØªØ§Ø¦Ø¬</p>';
        return;
    }
    
    const html = results.map(patient => `
        <div class="search-result-item" onclick="window.location.href='/patient/${patient.id}'">
            <div style="display: flex; justify-content: space-between; align-items: center;">
                <div style="flex: 1;">
                    <strong style="font-size: 1.1rem; color: #333;">${patient.name}</strong>
                    <div style="margin-top: 0.5rem; display: flex; gap: 1rem; flex-wrap: wrap; font-size: 0.9rem; color: #666;">
                        ${patient.phone ? `<span>ğŸ“± ${patient.phone}</span>` : ''}
                        ${patient.age ? `<span>ğŸ‚ ${patient.age} Ø³Ù†Ø©</span>` : ''}
                        ${patient.blood_type ? `<span style="color: #dc3545; font-weight: bold;">ğŸ©¸ ${patient.blood_type}</span>` : ''}
                    </div>
                    ${patient.national_id ? `<div style="margin-top: 0.3rem; font-size: 0.85rem; color: #999;">ğŸ†” ${patient.national_id}</div>` : ''}
                </div>
                <div style="text-align: center; margin-right: 1rem;">
                    ${patient.total_debt > 0 ? 
                        `<div style="background: #dc3545; color: white; padding: 0.5rem 1rem; border-radius: 8px; min-width: 80px;">
                            <div style="font-size: 0.75rem;">Ø¯ÙŠÙ†</div>
                            <div style="font-size: 1.2rem; font-weight: bold;">${patient.total_debt.toFixed(2)}</div>
                        </div>` :
                        `<span style="background: #28a745; color: white; padding: 0.5rem 1rem; border-radius: 8px; font-weight: bold;">âœ… Ù…Ø³Ø¯Ø¯</span>`
                    }
                </div>
            </div>
        </div>
    `).join('');
    
    resultsDiv.innerHTML = html;
}

// Load stats on page load
loadDashboardStats();
</script>
{% endblock %}
