{% extends "base.html" %}

{% block title %}Ù…ÙˆØ¹Ø¯ Ø¬Ø¯ÙŠØ¯ - {{ patient['name'] }}{% endblock %}

{% block content %}
<div class="form-container">
    <h2>ğŸ“… Ø¥Ø¶Ø§ÙØ© Ù…ÙˆØ¹Ø¯ Ø¬Ø¯ÙŠØ¯ - {{ patient['name'] }}</h2>
    
    <form id="newAppointmentForm">
        <div class="form-row">
            <div class="form-group">
                <label for="appointment_date">ØªØ§Ø±ÙŠØ® Ø§Ù„Ù…ÙˆØ¹Ø¯ *</label>
                <input type="date" id="appointment_date" name="appointment_date" required>
            </div>

            <div class="form-group">
                <label for="appointment_time">ÙˆÙ‚Øª Ø§Ù„Ù…ÙˆØ¹Ø¯ *</label>
                <input type="time" id="appointment_time" name="appointment_time" required>
            </div>
        </div>

        <div class="form-group">
            <label for="reason">Ø³Ø¨Ø¨ Ø§Ù„Ù…ÙˆØ¹Ø¯</label>
            <div class="input-with-voice">
                <input type="text" id="reason" name="reason" 
                       placeholder="Ù…Ø«Ø§Ù„: ÙØ­Øµ Ø¯ÙˆØ±ÙŠØŒ Ù…ØªØ§Ø¨Ø¹Ø©ØŒ Ø§Ø³ØªØ´Ø§Ø±Ø©">
                <button type="button" class="voice-btn" data-target="reason">ğŸ¤</button>
            </div>
        </div>

        <div class="form-group">
            <label for="status">Ø§Ù„Ø­Ø§Ù„Ø©</label>
            <select id="status" name="status">
                <option value="Ù…Ø¬Ø¯ÙˆÙ„">Ù…Ø¬Ø¯ÙˆÙ„</option>
                <option value="ØªÙ…">ØªÙ…</option>
                <option value="Ù…Ù„ØºÙŠ">Ù…Ù„ØºÙŠ</option>
            </select>
        </div>

        <div class="form-group">
            <label for="notes">Ù…Ù„Ø§Ø­Ø¸Ø§Øª</label>
            <div class="input-with-voice">
                <textarea id="notes" name="notes" rows="3"></textarea>
                <button type="button" class="voice-btn" data-target="notes">ğŸ¤</button>
            </div>
        </div>

        <div class="form-actions">
            <button type="submit" class="btn btn-primary">ğŸ’¾ Ø­ÙØ¸ Ø§Ù„Ù…ÙˆØ¹Ø¯</button>
            <a href="{{ url_for('patient_details', patient_id=patient['id']) }}" 
               class="btn btn-secondary">Ø¥Ù„ØºØ§Ø¡</a>
        </div>
    </form>
</div>
{% endblock %}

{% block extra_scripts %}
<script src="{{ url_for('static', filename='js/voice.js') }}"></script>
<script>
// Set minimum date to today
document.getElementById('appointment_date').min = new Date().toISOString().split('T')[0];

document.getElementById('newAppointmentForm').addEventListener('submit', async function(e) {
    e.preventDefault();
    
    const formData = {
        appointment_date: document.getElementById('appointment_date').value,
        appointment_time: document.getElementById('appointment_time').value,
        reason: document.getElementById('reason').value,
        status: document.getElementById('status').value,
        notes: document.getElementById('notes').value
    };
    
    try {
        const response = await fetch('/appointment/new/{{ patient["id"] }}', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify(formData)
        });
        
        const result = await response.json();
        
        if (result.success) {
            alert('âœ… ØªÙ… Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ù…ÙˆØ¹Ø¯ Ø¨Ù†Ø¬Ø§Ø­!');
            window.location.href = '/patient/{{ patient["id"] }}';
        }
    } catch (error) {
        alert('âŒ Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ù…ÙˆØ¹Ø¯');
        console.error(error);
    }
});
</script>
{% endblock %}
